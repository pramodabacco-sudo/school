generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum StaffRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
}

model Parent {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
}

model User {
  id          String    @id @default(uuid())
  name        String
  email       String    @unique
  password    String
  role        StaffRole
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  teacherProfile TeacherProfile?

  @@index([role])
  @@index([isActive])
}

// ─────────────────────────────────────────────────────────────
//  Student  (login / auth table — unchanged core, relations added)
// ─────────────────────────────────────────────────────────────
model Student {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  personalInfo StudentPersonalInfo?
  documents    StudentDocumentInfo[]
}

// ─────────────────────────────────────────────────────────────
//  StudentPersonalInfo
//  Sections: Personal · Contact · Academic · Parent/Guardian · Health
// ─────────────────────────────────────────────────────────────
model StudentPersonalInfo {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── Relation ──────────────────────────────────────────────
  studentId String  @unique
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // ── Personal Information ───────────────────────────────────
  firstName    String
  lastName     String
  dateOfBirth  DateTime?
  gender       Gender?
  profileImage String? // Cloudflare R2 / CDN URL

  // ── Contact Information ────────────────────────────────────
  phone   String?
  address String?
  city    String?
  state   String?
  zipCode String?

  // ── Academic Information ───────────────────────────────────
  grade         String
  className     String // e.g. "A", "B" — "class" is a reserved word in Prisma
  admissionDate DateTime
  status        StudentStatus @default(ACTIVE)

  // ── Parent / Guardian ──────────────────────────────────────
  parentName       String?
  parentEmail      String?
  parentPhone      String?
  emergencyContact String?

  // ── Health Information ─────────────────────────────────────
  bloodGroup        BloodGroup?
  medicalConditions String? // free text / comma-separated
  allergies         String?

  @@map("student_personal_info")
}

// ─────────────────────────────────────────────────────────────
//  StudentDocumentInfo
//  One row per document; file stored in Cloudflare R2,
//  only the document name / metadata lives here.
// ─────────────────────────────────────────────────────────────
model StudentDocumentInfo {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Document Details
  documentName DocumentType
  customLabel  String?

  // Permanent storage pointer (REAL reference)
  fileKey String // e.g. students/{studentId}/{uuid}.pdf

  // Temporary signed URL (NEVER trusted, regenerated on each request)
  fileUrl String? // last generated signed URL cache

  fileType      String
  fileSizeBytes Int?

  // Verification workflow
  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  uploadedAt DateTime @default(now())

  @@map("student_document_info")
}

// ─────────────────────────────────────────────────────────────
//  Enums
// ─────────────────────────────────────────────────────────────

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  INACTIVE
  GRADUATED
  SUSPENDED
}

enum BloodGroup {
  A_POS  @map("A+")
  A_NEG  @map("A-")
  B_POS  @map("B+")
  B_NEG  @map("B-")
  O_POS  @map("O+")
  O_NEG  @map("O-")
  AB_POS @map("AB+")
  AB_NEG @map("AB-")
}

enum DocumentType {
  AADHAR_CARD // Aadhar / national ID
  BIRTH_CERTIFICATE
  PASSBOOK // Bank passbook
  TRANSFER_CERTIFICATE
  MARKSHEET
  MIGRATION_CERTIFICATE
  CHARACTER_CERTIFICATE
  MEDICAL_CERTIFICATE
  PASSPORT
  CASTE_CERTIFICATE
  INCOME_CERTIFICATE
  PHOTO
  CUSTOM // user-defined label stored in customLabel
}

// ─────────────────────────────────────────────────────────────
//  Teacher Profile (Professional CRM Structure)
// ─────────────────────────────────────────────────────────────
model TeacherProfile {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // ── Relation (Login Account) ───────────────────────────────
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // ── Basic Info ─────────────────────────────────────────────
  employeeCode String    @unique
  firstName    String
  lastName     String
  dateOfBirth  DateTime?
  gender       Gender?
  phone        String?
  address      String?
  city         String?
  state        String?
  zipCode      String?
  profileImage String?

  // ── Professional Info ─────────────────────────────────────
  department      String
  designation     String // e.g. Senior Teacher, HOD
  qualification   String?
  experienceYears Int?
  joiningDate     DateTime
  employmentType  EmploymentType
  status          TeacherStatus  @default(ACTIVE)

  // ── Payroll Info ───────────────────────────────────────────
  salary        Decimal? @db.Decimal(10, 2)
  bankAccountNo String?
  bankName      String?
  ifscCode      String?
  panNumber     String?
  aadhaarNumber String?

  // ── Relations ──────────────────────────────────────────────
  assignments TeacherAssignment[]
  documents   TeacherDocument[]

  @@index([department])
  @@index([designation])
  @@index([status])
  @@index([joiningDate])
  @@map("teacher_profiles")
}

// ─────────────────────────────────────────────────────────────
//  Teacher Assignment (Classes & Subjects)
// ─────────────────────────────────────────────────────────────
model TeacherAssignment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  grade     String
  className String
  subject   String

  academicYear String

  @@index([teacherId])
  @@index([grade, className])
  @@index([academicYear])
  @@map("teacher_assignments")
}

// ─────────────────────────────────────────────────────────────
//  Teacher Documents
// ─────────────────────────────────────────────────────────────
model TeacherDocument {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  documentType TeacherDocumentType
  customLabel  String?

  fileKey String
  fileUrl String?

  fileType      String
  fileSizeBytes Int?

  isVerified Boolean   @default(false)
  verifiedAt DateTime?

  @@index([teacherId])
  @@index([documentType])
  @@map("teacher_documents")
}

// ─────────────────────────────────────────────────────────────
//  Enums
// ─────────────────────────────────────────────────────────────

enum TeacherStatus {
  ACTIVE
  ON_LEAVE
  RESIGNED
  TERMINATED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
}

enum TeacherDocumentType {
  ID_PROOF
  ADDRESS_PROOF
  DEGREE_CERTIFICATE
  EXPERIENCE_CERTIFICATE
  CONTRACT_DOCUMENT
  PAN_CARD
  AADHAR_CARD
  PHOTO
  CUSTOM
}
