// ═══════════════════════════════════════════════════════════════
//  ACADEMIC ERP — UPDATED PRISMA SCHEMA
//  Added: Stream, Course, CourseBranch, SchoolPromotionConfig,
//         StudentReadmission, updated StudentStatus + SchoolType
// ═══════════════════════════════════════════════════════════════

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ═══════════════════════════════════════════════════════════════
//  ENUMS
// ═══════════════════════════════════════════════════════════════

enum StaffRole {
  SUPER_ADMIN
  ADMIN
  TEACHER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum StudentStatus {
  ACTIVE
  INACTIVE // Transferred to another school
  GRADUATED // Completed last grade
  SUSPENDED // Admin decides manually
  PENDING_READMISSION // Grade 7 skip — waiting for re-admission
  FAILED // Held back, repeats same grade next year
}

enum BloodGroup {
  A_POS  @map("A+")
  A_NEG  @map("A-")
  B_POS  @map("B+")
  B_NEG  @map("B-")
  O_POS  @map("O+")
  O_NEG  @map("O-")
  AB_POS @map("AB+")
  AB_NEG @map("AB-")
}

enum DocumentType {
  AADHAR_CARD
  BIRTH_CERTIFICATE
  PASSBOOK
  TRANSFER_CERTIFICATE
  MARKSHEET
  MIGRATION_CERTIFICATE
  CHARACTER_CERTIFICATE
  MEDICAL_CERTIFICATE
  PASSPORT
  CASTE_CERTIFICATE
  INCOME_CERTIFICATE
  PHOTO
  CUSTOM
}

enum TeacherStatus {
  ACTIVE
  ON_LEAVE
  RESIGNED
  TERMINATED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  TEMPORARY
}

enum TeacherDocumentType {
  ID_PROOF
  ADDRESS_PROOF
  DEGREE_CERTIFICATE
  EXPERIENCE_CERTIFICATE
  CONTRACT_DOCUMENT
  PAN_CARD
  AADHAR_CARD
  PHOTO
  CUSTOM
}

// ── UPDATED: Simplified school types ────────────────────────────
enum SchoolType {
  SCHOOL // Grade 1–10 (Primary, Upper Primary, High School all combined)
  PUC // Grade 11–12 with streams
  DIPLOMA // Semester-based (3 years typically)
  DEGREE // Semester-based (3–5 years)
  POSTGRADUATE // Semester-based (2 years)
  OTHER
}

enum SlotType {
  PERIOD
  SHORT_BREAK
  LUNCH_BREAK
  PRAYER
  OTHER
}

enum WeekDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExtraClassDay {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum ExtraClassType {
  HOLIDAY
  WEEKEND
  BEFORE_HOURS
  AFTER_HOURS
  OTHER
}

enum MeetingType {
  STAFF
  PARENT
  STUDENT
  GENERAL
  BOARD
  CUSTOM
}

enum MeetingStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  POSTPONED
}

enum MeetingParticipantType {
  USER
  PARENT
  EXTERNAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  EXCUSED
}

enum TeacherAttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

// ── NEW: Course type enum ────────────────────────────────────────
enum CourseType {
  STREAM // PUC: Science, Commerce, Arts
  DEGREE_COURSE // Degree/Diploma/PG: BTech, BA, BCom
}

// ── NEW: Promotion action enum ───────────────────────────────────
enum PromotionAction {
  PROMOTED
  GRADUATED
  SKIPPED // Grade 7 — PENDING_READMISSION
  READMITTED
}

// ═══════════════════════════════════════════════════════════════
//  UNIVERSITY
// ═══════════════════════════════════════════════════════════════

model University {
  id        String   @id @default(uuid())
  name      String
  code      String   @unique
  address   String?
  city      String?
  state     String?
  phone     String?
  email     String?
  website   String?
  logoUrl   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  superAdmins SuperAdmin[]
  schools     School[]

  @@index([code])
  @@map("universities")
}

// ═══════════════════════════════════════════════════════════════
//  SUPER ADMIN
// ═══════════════════════════════════════════════════════════════

model SuperAdmin {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  password     String
  phone        String?
  profileImage String?
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  universityId String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  schoolAccess SuperAdminSchoolAccess[]

  @@index([universityId])
  @@map("super_admins")
}

model SuperAdminSchoolAccess {
  id           String     @id @default(uuid())
  superAdminId String
  superAdmin   SuperAdmin @relation(fields: [superAdminId], references: [id], onDelete: Cascade)
  schoolId     String
  school       School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@unique([superAdminId, schoolId])
  @@map("super_admin_school_access")
}

// ═══════════════════════════════════════════════════════════════
//  SCHOOL
// ═══════════════════════════════════════════════════════════════

model School {
  id        String     @id @default(uuid())
  name      String
  code      String     @unique
  type      SchoolType
  address   String?
  city      String?
  state     String?
  phone     String?
  email     String?
  isActive  Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  universityId String
  university   University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  superAdminAccess  SuperAdminSchoolAccess[]
  users             User[]
  students          Student[]
  parents           Parent[]
  teachers          TeacherProfile[]
  academicYears     AcademicYear[]
  classSections     ClassSection[]
  subjects          Subject[]
  timetableConfigs  TimetableConfig[]
  timetableEntries  TimetableEntry[]
  assessmentTerms   AssessmentTerm[]
  assessmentGroups  AssessmentGroup[]
  extraClasses      ExtraClass[]
  meetings          Meeting[]
  TeacherAttendance TeacherAttendance[]

  // ── NEW relations ────────────────────────────────────────────
  streams         Stream[]
  courses         Course[]
  promotionConfig SchoolPromotionConfig?
  promotionLogs   PromotionLog[]

  @@index([universityId])
  @@index([type])
  @@index([code])
  @@map("schools")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: STREAM (PUC only — Science, Commerce, Arts etc.)
// ═══════════════════════════════════════════════════════════════

model Stream {
  id              String   @id @default(uuid())
  name            String // "Science", "Commerce", "Arts", "Vocational"
  code            String? // Optional short code
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  hasCombinations Boolean  @default(false)
  schoolId        String
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classSections ClassSection[]
  combinations  StreamCombination[]

  @@unique([name, schoolId])
  @@index([schoolId])
  @@map("streams")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: COURSE (Degree/Diploma/PG — BTech, BA, BCom etc.)
// ═══════════════════════════════════════════════════════════════

model Course {
  id             String     @id @default(uuid())
  name           String // "BTech", "BA", "BCom", "Civil Engineering"
  code           String? // Optional short code "CS", "ME"
  type           CourseType @default(DEGREE_COURSE)
  totalSemesters Int // BTech=8, BA=6, Diploma=6
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  schoolId      String
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  hasBranches   Boolean        @default(false)
  branches      CourseBranch[]
  classSections ClassSection[]

  @@unique([name, schoolId])
  @@index([schoolId])
  @@map("courses")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: COURSE BRANCH (CSE, ECE under BTech etc.)
// ═══════════════════════════════════════════════════════════════

model CourseBranch {
  id        String   @id @default(uuid())
  name      String // "Computer Science", "Electronics"
  code      String? // "CSE", "ECE"
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  courseId String
  course   Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  classSections ClassSection[]

  @@unique([name, courseId])
  @@index([courseId])
  @@map("course_branches")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: SCHOOL PROMOTION CONFIG
//  Auto-created when school is created based on schoolType
// ═══════════════════════════════════════════════════════════════

model SchoolPromotionConfig {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // Grades to skip during promotion (only for SCHOOL type)
  // e.g., ["Grade 7"] — these students get PENDING_READMISSION
  skipGrades String[]

  // Last grade/semester — students here get GRADUATED
  // e.g., "Grade 10", "Grade 12", "Semester 8"
  // For DEGREE/DIPLOMA: handled per-course via Course.totalSemesters
  lastGrade String?

  // First grade/semester — always empty (fresh admissions)
  // e.g., "Grade 1", "Grade 11", "Semester 1"
  firstGrade String?

  @@map("school_promotion_configs")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: PROMOTION LOG
//  Tracks each promotion run for audit trail
// ═══════════════════════════════════════════════════════════════

model PromotionLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  fromAcademicYearId String
  toAcademicYearId   String

  totalPromoted  Int @default(0)
  totalGraduated Int @default(0)
  totalSkipped   Int @default(0) // PENDING_READMISSION
  totalFailed    Int @default(0)
  totalInactive  Int @default(0)

  triggeredById String // userId of admin who ran promotion
  notes         String?

  @@index([schoolId])
  @@map("promotion_logs")
}

// ═══════════════════════════════════════════════════════════════
//  NEW: STUDENT READMISSION
//  Tracks Grade 7 → Grade 8 re-admissions (School type only)
// ═══════════════════════════════════════════════════════════════

model StudentReadmission {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Previous info (preserved history)
  previousAdmissionNumber String
  previousGrade           String // "Grade 7"
  previousAcademicYearId  String
  previousClassSectionId  String

  // New info after re-admission
  newAdmissionNumber String
  newGrade           String // "Grade 8"
  newAcademicYearId  String
  newClassSectionId  String

  reason          String?
  readmissionDate DateTime @default(now())

  @@index([studentId])
  @@map("student_readmissions")
}

// ═══════════════════════════════════════════════════════════════
//  PARENT
// ═══════════════════════════════════════════════════════════════

enum ParentRelation {
  FATHER
  MOTHER
  GUARDIAN
}

model Parent {
  id           String   @id @default(uuid())
  name         String
  email        String
  password     String
  phone        String?
  occupation   String?
  profileImage String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  studentLinks          StudentParent[]
  meetingParticipations MeetingParticipant[]

  @@unique([email, schoolId])
  @@index([schoolId])
  @@map("parents")
}

model StudentParent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  parentId String
  parent   Parent @relation(fields: [parentId], references: [id], onDelete: Cascade)

  relation         ParentRelation
  isPrimary        Boolean        @default(false)
  emergencyContact Boolean        @default(false)

  @@unique([studentId, parentId])
  @@unique([studentId, relation])
  @@index([studentId])
  @@index([parentId])
  @@map("student_parents")
}

// ═══════════════════════════════════════════════════════════════
//  USER
// ═══════════════════════════════════════════════════════════════

model User {
  id          String    @id @default(uuid())
  name        String
  email       String
  password    String
  role        StaffRole
  isActive    Boolean   @default(true)
  lastLoginAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  organizedMeetings        Meeting[]            @relation("MeetingOrganizer")
  teacherProfile           TeacherProfile?
  meetingParticipations    MeetingParticipant[]
  markedAttendances        AttendanceRecord[]   @relation("AttendanceMarkedBy")
  markedTeacherAttendances TeacherAttendance[]  @relation("TeacherAttendanceMarkedBy")

  @@unique([email, schoolId])
  @@index([role])
  @@index([isActive])
  @@index([schoolId])
  @@map("users")
}

// ═══════════════════════════════════════════════════════════════
//  STUDENT
// ═══════════════════════════════════════════════════════════════

model Student {
  id        String   @id @default(uuid())
  name      String
  email     String
  password  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  admissionNumber String
  schoolId        String
  school          School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  personalInfo      StudentPersonalInfo?
  documents         StudentDocumentInfo[]
  enrollments       StudentEnrollment[]
  marks             Marks[]
  resultSummaries   ResultSummary[]
  parentLinks       StudentParent[]
  meetings          MeetingStudent[]
  attendanceRecords AttendanceRecord[]

  // ── NEW ────────────────────────────────────────────────────
  readmissions StudentReadmission[]

  @@unique([email, schoolId])
  @@unique([admissionNumber, schoolId])
  @@index([schoolId])
  @@map("students")
}

// ═══════════════════════════════════════════════════════════════
//  STUDENT PERSONAL INFO
// ═══════════════════════════════════════════════════════════════

model StudentPersonalInfo {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentId String  @unique
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  firstName    String
  lastName     String
  dateOfBirth  DateTime?
  gender       Gender?
  profileImage String?

  phone   String?
  address String?
  city    String?
  state   String?
  zipCode String?

  admissionDate DateTime
  rollNumber    String?
  status        StudentStatus @default(ACTIVE)

  parentName       String?
  parentEmail      String?
  parentPhone      String?
  emergencyContact String?

  bloodGroup        BloodGroup?
  medicalConditions String?
  allergies         String?

  @@map("student_personal_info")
}

// ═══════════════════════════════════════════════════════════════
//  STUDENT ENROLLMENT
// ═══════════════════════════════════════════════════════════════

model StudentEnrollment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  rollNumber String?
  externalId String?
  status     StudentStatus @default(ACTIVE)

  @@unique([classSectionId, academicYearId, rollNumber])
  @@unique([studentId, academicYearId])
  @@index([classSectionId])
  @@index([academicYearId])
  @@map("student_enrollments")
}

// ═══════════════════════════════════════════════════════════════
//  STUDENT DOCUMENTS
// ═══════════════════════════════════════════════════════════════

model StudentDocumentInfo {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  documentName DocumentType
  customLabel  String?

  fileKey       String
  fileUrl       String?
  fileType      String
  fileSizeBytes Int?

  isVerified Boolean   @default(false)
  verifiedAt DateTime?
  uploadedAt DateTime  @default(now())

  @@index([studentId])
  @@map("student_document_info")
}

// ═══════════════════════════════════════════════════════════════
//  SUBJECT
// ═══════════════════════════════════════════════════════════════

model Subject {
  id          String  @id @default(uuid())
  name        String
  code        String?
  description String?
  isElective  Boolean @default(false)
  gradeLevel  String?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classSubjects       ClassSubject[]
  timetableEntries    TimetableEntry[]
  assessmentSchedules AssessmentSchedule[]
  TeacherAssignment   TeacherAssignment[]
  extraClasses        ExtraClass[]

  @@unique([code, schoolId])
  @@index([schoolId])
  @@index([gradeLevel])
  @@map("subjects")
}

// ═══════════════════════════════════════════════════════════════
//  CLASS SUBJECT
// ═══════════════════════════════════════════════════════════════

model ClassSubject {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([classSectionId, subjectId, academicYearId])
  @@index([classSectionId])
  @@index([academicYearId])
  @@map("class_subjects")
}

// ═══════════════════════════════════════════════════════════════
//  TEACHER PROFILE
// ═══════════════════════════════════════════════════════════════

model TeacherProfile {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  employeeCode    String         @unique
  firstName       String
  lastName        String
  dateOfBirth     DateTime?
  gender          Gender?
  phone           String?
  address         String?
  city            String?
  state           String?
  zipCode         String?
  profileImage    String?
  department      String
  designation     String
  qualification   String?
  experienceYears Int?
  joiningDate     DateTime
  employmentType  EmploymentType
  status          TeacherStatus  @default(ACTIVE)
  salary          Decimal?       @db.Decimal(10, 2)
  bankAccountNo   String?
  bankName        String?
  ifscCode        String?
  panNumber       String?
  aadhaarNumber   String?

  assignments        TeacherAssignment[]
  documents          TeacherDocument[]
  timetableEntries   TimetableEntry[]
  classTeacherOf     ClassSectionAcademicYear[]
  extraClasses       ExtraClass[]
  teacherAttendances TeacherAttendance[]

  @@index([schoolId])
  @@index([department])
  @@index([status])
  @@map("teacher_profiles")
}

// ═══════════════════════════════════════════════════════════════
//  TEACHER ASSIGNMENT
// ═══════════════════════════════════════════════════════════════

model TeacherAssignment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  @@unique([classSectionId, subjectId, academicYearId])
  @@index([teacherId])
  @@index([academicYearId])
  @@map("teacher_assignments")
}

// ═══════════════════════════════════════════════════════════════
//  TEACHER DOCUMENTS
// ═══════════════════════════════════════════════════════════════

model TeacherDocument {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  documentType  TeacherDocumentType
  customLabel   String?
  fileKey       String
  fileUrl       String?
  fileType      String
  fileSizeBytes Int?
  isVerified    Boolean             @default(false)
  verifiedAt    DateTime?

  @@index([teacherId])
  @@index([documentType])
  @@map("teacher_documents")
}

// ═══════════════════════════════════════════════════════════════
//  ACADEMIC YEAR
// ═══════════════════════════════════════════════════════════════

model AcademicYear {
  id        String   @id @default(uuid())
  name      String
  startDate DateTime
  endDate   DateTime
  isActive  Boolean  @default(false)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  classSectionYears  ClassSectionAcademicYear[]
  timetableConfigs   TimetableConfig[]
  timetableEntries   TimetableEntry[]
  classSubjects      ClassSubject[]
  teacherAssignments TeacherAssignment[]
  assessmentTerms    AssessmentTerm[]
  assessmentGroups   AssessmentGroup[]
  resultSummaries    ResultSummary[]
  studentEnrollments StudentEnrollment[]
  extraClasses       ExtraClass[]
  meetings           Meeting[]
  attendanceRecords  AttendanceRecord[]
  TeacherAttendance  TeacherAttendance[]

  @@unique([name, schoolId])
  @@index([schoolId])
  @@map("academic_years")
}

// ═══════════════════════════════════════════════════════════════
//  CLASS SECTION  — UPDATED with stream/course/branch
// ═══════════════════════════════════════════════════════════════

model ClassSection {
  id      String  @id @default(uuid())
  grade   String // "Grade 1", "Grade 11", "Semester 1"
  section String? // Optional — null means only one section for this grade
  name    String // Auto-generated display name

  combinationId String?

  schoolId    String
  school      School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  combination StreamCombination? @relation(fields: [combinationId], references: [id], onDelete: SetNull)

  // ── PUC only ──────────────────────────────────────────────
  streamId String?
  stream   Stream? @relation(fields: [streamId], references: [id], onDelete: SetNull)

  // ── Degree/Diploma/PG only ────────────────────────────────
  courseId String?
  course   Course? @relation(fields: [courseId], references: [id], onDelete: SetNull)

  branchId String?
  branch   CourseBranch? @relation(fields: [branchId], references: [id], onDelete: SetNull)

  academicYearLinks   ClassSectionAcademicYear[]
  classSubjects       ClassSubject[]
  teacherAssignments  TeacherAssignment[]
  timetableEntries    TimetableEntry[]
  assessmentSchedules AssessmentSchedule[]
  studentEnrollments  StudentEnrollment[]
  extraClasses        ExtraClass[]
  meetings            MeetingClass[]
  attendanceRecords   AttendanceRecord[]

  // Note: unique constraint needs to account for nullable section
  // Handled at application level for flexibility
  @@index([schoolId])
  @@index([grade, schoolId])
  @@index([streamId])
  @@index([courseId])
  @@map("class_sections")
}

// ═══════════════════════════════════════════════════════════════
//  CLASS SECTION × ACADEMIC YEAR
// ═══════════════════════════════════════════════════════════════

model ClassSectionAcademicYear {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  classTeacherId String?
  classTeacher   TeacherProfile? @relation(fields: [classTeacherId], references: [id], onDelete: SetNull)

  isActive Boolean @default(true)

  @@unique([classSectionId, academicYearId])
  @@index([academicYearId])
  @@map("class_section_academic_years")
}

// ═══════════════════════════════════════════════════════════════
//  TIMETABLE CONFIG
// ═══════════════════════════════════════════════════════════════

model TimetableConfig {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  startTime      String
  endTime        String
  periodDuration Int
  totalPeriods   Int

  slots TimetablePeriodSlot[]

  @@unique([schoolId, academicYearId])
  @@map("timetable_configs")
}

model TimetablePeriodSlot {
  id String @id @default(uuid())

  configId String
  config   TimetableConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  slotOrder        Int
  slotType         SlotType
  startTime        String
  endTime          String
  label            String
  timetableEntries TimetableEntry[]

  @@index([configId])
  @@map("timetable_period_slots")
}

// ═══════════════════════════════════════════════════════════════
//  TIMETABLE ENTRY
// ═══════════════════════════════════════════════════════════════

model TimetableEntry {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  periodSlotId String
  periodSlot   TimetablePeriodSlot @relation(fields: [periodSlotId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  day WeekDay

  @@unique([classSectionId, day, periodSlotId])
  @@unique([teacherId, day, periodSlotId])
  @@index([schoolId])
  @@index([teacherId])
  @@map("timetable_entries")
}

// ═══════════════════════════════════════════════════════════════
//  ASSESSMENT TERM
// ═══════════════════════════════════════════════════════════════

model AssessmentTerm {
  id    String @id @default(uuid())
  name  String
  order Int?

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  assessmentGroups AssessmentGroup[]
  ResultSummary    ResultSummary[]

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([academicYearId])
  @@map("assessment_terms")
}

// ═══════════════════════════════════════════════════════════════
//  ASSESSMENT GROUP
// ═══════════════════════════════════════════════════════════════

model AssessmentGroup {
  id          String  @id @default(uuid())
  name        String
  weightage   Float?
  isPublished Boolean @default(false)
  isLocked    Boolean @default(false)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  termId String?
  term   AssessmentTerm? @relation(fields: [termId], references: [id], onDelete: SetNull)

  schedules     AssessmentSchedule[]
  ResultSummary ResultSummary[]

  createdAt DateTime @default(now())

  @@index([schoolId])
  @@index([academicYearId])
  @@map("assessment_groups")
}

// ═══════════════════════════════════════════════════════════════
//  ASSESSMENT SCHEDULE
// ═══════════════════════════════════════════════════════════════

model AssessmentSchedule {
  id String @id @default(uuid())

  assessmentGroupId String
  assessmentGroup   AssessmentGroup @relation(fields: [assessmentGroupId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  maxMarks     Float
  passingMarks Float?
  examDate     DateTime
  startTime    DateTime
  endTime      DateTime

  marks Marks[]

  @@index([classSectionId])
  @@index([assessmentGroupId])
  @@map("assessment_schedules")
}

// ═══════════════════════════════════════════════════════════════
//  MARKS
// ═══════════════════════════════════════════════════════════════

model Marks {
  id String @id @default(uuid())

  scheduleId String
  schedule   AssessmentSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  marksObtained Float?
  isAbsent      Boolean @default(false)
  remarks       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([scheduleId, studentId])
  @@index([studentId])
  @@map("marks")
}

// ═══════════════════════════════════════════════════════════════
//  RESULT SUMMARY
// ═══════════════════════════════════════════════════════════════

model ResultSummary {
  id String @id @default(uuid())

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  termId String?
  term   AssessmentTerm? @relation(fields: [termId], references: [id], onDelete: SetNull)

  assessmentGroupId String?
  assessmentGroup   AssessmentGroup? @relation(fields: [assessmentGroupId], references: [id], onDelete: SetNull)

  totalMarks  Float?
  maxMarks    Float?
  percentage  Float?
  grade       String?
  isPublished Boolean @default(false)

  @@unique([studentId, academicYearId, termId, assessmentGroupId])
  @@index([studentId])
  @@index([academicYearId])
  @@map("result_summaries")
}

// ═══════════════════════════════════════════════════════════════
//  EXTRA CLASS
// ═══════════════════════════════════════════════════════════════

model ExtraClass {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  subjectId String
  subject   Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  specificDate DateTime?
  recurringDay ExtraClassDay?
  startTime    String
  endTime      String
  type         ExtraClassType @default(OTHER)
  reason       String?
  isActive     Boolean        @default(true)

  @@index([schoolId])
  @@index([classSectionId])
  @@index([academicYearId])
  @@index([teacherId])
  @@map("extra_classes")
}

// ═══════════════════════════════════════════════════════════════
//  MEETING
// ═══════════════════════════════════════════════════════════════

model Meeting {
  id          String  @id @default(uuid())
  title       String
  description String?

  type   MeetingType
  status MeetingStatus @default(SCHEDULED)

  meetingDate DateTime
  startTime   String
  endTime     String

  venueType   String?
  venueDetail String?
  location    String?
  meetingLink String?
  notes       String?

  reminderSentAt DateTime?

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String?
  academicYear   AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)

  organizerId String
  organizer   User   @relation("MeetingOrganizer", fields: [organizerId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  participants MeetingParticipant[]
  classes      MeetingClass[]
  students     MeetingStudent[]

  @@index([schoolId])
  @@index([meetingDate])
  @@index([type])
  @@map("meetings")
}

model MeetingParticipant {
  id String @id @default(uuid())

  meetingId String
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  type MeetingParticipantType

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  parentId String?
  parent   Parent? @relation(fields: [parentId], references: [id], onDelete: SetNull)

  name          String?
  email         String?
  isCoordinator Boolean @default(false)
  attended      Boolean @default(false)

  @@unique([meetingId, userId, parentId, email])
  @@index([meetingId])
  @@map("meeting_participants")
}

model MeetingClass {
  id String @id @default(uuid())

  meetingId String
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  @@unique([meetingId, classSectionId])
  @@map("meeting_classes")
}

model MeetingStudent {
  id String @id @default(uuid())

  meetingId String
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  attended Boolean @default(false)

  @@unique([meetingId, studentId])
  @@map("meeting_students")
}

model AttendanceRecord {
  id      String           @id @default(uuid())
  date    DateTime
  status  AttendanceStatus @default(PRESENT)
  remarks String?

  studentId String
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  classSectionId String
  classSection   ClassSection @relation(fields: [classSectionId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  markedById String?
  markedBy   User?   @relation("AttendanceMarkedBy", fields: [markedById], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, date, academicYearId])
  @@index([classSectionId, date])
  @@index([academicYearId])
  @@index([studentId])
  @@map("attendance_records")
}

model TeacherAttendance {
  id      String                  @id @default(uuid())
  date    DateTime
  status  TeacherAttendanceStatus @default(PRESENT)
  remarks String?

  teacherId String
  teacher   TeacherProfile @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  schoolId String
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  academicYearId String
  academicYear   AcademicYear @relation(fields: [academicYearId], references: [id], onDelete: Cascade)

  markedById String
  markedBy   User   @relation("TeacherAttendanceMarkedBy", fields: [markedById], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teacherId, date, academicYearId])
  @@index([date])
  @@index([teacherId])
  @@index([schoolId])
  @@map("teacher_attendance")
}

// New model:
model StreamCombination {
  id        String   @id @default(uuid())
  name      String // "PCMB", "PCMC", "CEBA"
  code      String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  streamId String
  stream   Stream @relation(fields: [streamId], references: [id], onDelete: Cascade)

  classSections ClassSection[]

  @@unique([name, streamId])
  @@index([streamId])
  @@map("stream_combinations")
}
